{% extends 'hacoweb/core.html' %}
{% load static %}

<head>
    <title>{% block title %}Haco | Wildfire Management{% endblock %}</title>
</head>

<body>
    <!-- Main Body -->
    {% block content %}

        <div id="init_map">
        </div>

        <script type="text/javascript">
            window.addEventListener('load', (e) => {
                let latlng; // used to update coordinates as they change
                let markers = []; // will store markers

                // init map
                let map = L.map('init_map', {
                    zoom: 13,
                    dragging: !L.Browser.mobile,
                    tap: !L.Browser.mobile,
                    canvas: L.canvas()

                }).locate({setView: true, setZoom: 300})
                .on('locationfound', (e)=> {
                    let marker = L.marker([e.latitude, e.longitude], {
                        maxZoom: 18,
                        tileSize: 512,
                        zoomOffset: -1,
                        draggable: true,
                        autoPan: true
                    })
                    // after the marker has been dropped, regather coordinates pass them out to global var
                    .on('dragend', () => {
                        marker.unbindPopup();
                        latlng = marker.getLatLng();
                        marker.bindPopup('Lat: ' + latlng.lat.toFixed(6) + ', Lon: ' + latlng.lng.toFixed(6));
                        marker.openPopup();
                        circle.remove();
                    })
                    .bindPopup('Lat: ' + e.latitude + ', Lon: ' + e.longitude)

                    let circle = L.circle([e.latitude, e.longitude], e.accuracy / 2, {
                        weight: 1,
                        color: '#b6e0e2',
                        fillColor: '#CACACA',
                        fillOpacity: 0.2
                    })
                    // Add the marker/circle to the map
                    map.addLayer(marker);
                    map.addLayer(circle);
                    // Open the popup
                    marker.openPopup();
                })
                // Usually permission is revoked if this is caused...
                .on('locationerror', (e) => {
                    console.log('Location permission revoked: ' + (e));
                })

                L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZGVhbjE5OTYiLCJhIjoiY2tsbDYyNzFqMm5idDJxcDd5cjY2bTAwdSJ9.n2dX9LFuOIujqKaPJUJK2Q', {
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                    maxZoom: 18,
                    id: 'mapbox/streets-v11',
                    tileSize: 512,
                    zoomOffset: -1,
                    accessToken: 'pk.eyJ1IjoiZGVhbjE5OTYiLCJhIjoiY2tsbDYyNzFqMm5idDJxcDd5cjY2bTAwdSJ9.n2dX9LFuOIujqKaPJUJK2Q'
                }).addTo(map);

                let raw_data = '{{ latest_events|escapejs }}';
                let data = JSON.parse(raw_data);

                // Custom Icon
                let hacoIcon = L.icon({
                    iconUrl: '{% static 'hacoweb/img/haco.svg' %}',
                    iconSize: [37,37],
                    iconAnchor: [15, 37],
                    popupAnchor: [0, -28]
                });

                L.geoJSON(data, {
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup(
                            "<p class='event-desc'>" + "Bright_ti4: " + feature.properties.Bright_ti4 + "</p>" +
                            "<p class='event-desc'>" + "Scan: " + feature.properties.Scan + "</p>" +
                            "<p class='event-desc'>" + "Track: " + feature.properties.Track + "</p>" +
                            "<p class='event-desc'>" + "Date Acquired: " + feature.properties.Acq_date + "</p>" +
                            "<p class='event-desc'>" + "Time Acquired: " + feature.properties.Acq_time + "</p>" +
                            "<p class='event-desc'>" + "Satellite: " + feature.properties.Satellite + "</p>" +
                            "<p class='event-desc'>" + "Confidence: " + feature.properties.Confidence + "</p>" +
                            "<p class='event-desc'>" + "Version: " + feature.properties.Version + "</p>" +
                            "<p class='event-desc'>" + "Bright_ti5: " + feature.properties.Bright_ti5 + "</p>" +
                            "<p class='event-desc'>" + "Frp: " + feature.properties.Frp + "</p>" +
                            "<p class='event-desc'>" + "Daynight: " + feature.properties.Daynight + "</p>" +
                            "<p class='event-desc'>" + "Resolution: " + feature.properties.Resolution + "</p>"
                        );
                    },
                    pointToLayer: function(feature, latlng) {
                        return L.marker(latlng, {icon: hacoIcon});
                    }
                }).addTo(map);
            });

        </script>
    {% endblock %}
</body>