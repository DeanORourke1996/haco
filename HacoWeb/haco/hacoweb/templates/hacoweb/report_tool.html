{% extends 'hacoweb/core.html' %}
{% load static %}

<head>
    <title>{% block title %}Haco | Report a Fire{% endblock %}</title>
</head>

<body>
    {% block content %}
        <!-- Required to POST data -->
        {% csrf_token %}

        <div class="report-instructions container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <p>Change the location by moving the marker around below on the map. If the fire is some distance away,
                    you can estimate where you should place the marker and submit!</p>
                </div>
            </div>
        </div>

        <div class="report-form container-fluid">
            <div class="row justify-content-center">
                <div class="col-sm-12 col-lg-3">
                    <label>Latitude</label>
                    <input type="text" id="latitude" class="form-control" placeholder="Latitude" aria-label="Latitude">
                </div>
                <div class="col-sm-12 col-lg-3">
                    <label>Latitude</label>
                    <input type="text" id="longitude" class="form-control" placeholder="Longitude" aria-label="Longitude">
                </div>
                <div class="col-sm-12 col-lg-3">
                    <label>Fire Severity</label>
                    <select id="severity" class="form-select" aria-label="Severity">
                        <option value="null" selected>Choose an Option</option>
                        <option value="severe">Severe (Fire is Out of Control)</option>
                        <option value="moderate">Moderate (Fire is Growing)</option>
                        <option value="light">Small (Fire is Small and isn't spreading)</option>
                    </select>
                </div>
                <div class="col-sm-12 col-lg-3">
                    <button id="submit_report" class="btn submit-report" type="submit">Submit</button>
                </div>
            </div>
        </div>

        <!-- Error Checking -->
        <p class="submit-errors" id="submit_error_coord">Ensure that the marker has been set on a location before submitting. Browser location settings may affect this</p>
        <p class="submit-errors" id="submit_error_nullity">Ensure that all fields have been filled out before submitting</p>

        <!-- Wrapper Element for Map -->
        <div id="report_map" class="map">
        </div>


        <!-- Script for Report Mapping Tool -->
        <script type="text/javascript">
            // Set url
            let URL = "{% url 'sendreport' %}";
            // Const variable Cross-site request forgery token. Required by Django to POST data to Views
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;


            $(document).ready(function() {
                // Submit Button Element
                let elSubmit = document.getElementById('submit_report');

                // Event listener on Submit Button
                elSubmit.addEventListener('click', function () {
                    // Disable this button
                    // elSubmit.disabled = true;
                    // Check everything being sent
                    let latitude = document.getElementById('latitude').value;
                    let longitude = document.getElementById('longitude').value;
                    let severity = document.getElementById('severity').value;

                    // Testing, testing 1, 2
                    console.log(latitude);
                    console.log(longitude);
                    console.log(severity);

                    // Check for nullity
                    if (!latitude || !longitude) {
                        // Error with Coord fields, will be related to location settings or marker
                        document.getElementById('submit_error_coord').style.display = "block";
                    } else if(severity === "null") {
                        // Error with null values
                        document.getElementById('submit_error_nullity').style.display = "block";
                    } else {
                        // hide them otherwise
                        document.getElementById('submit_error_coord').style.display = "none";
                        document.getElementById('submit_error_nullity').style.display = "none";

                        // Build Incident Report
                        let reportIncident = {
                            "latitude": latitude,
                            "longitude": longitude,
                            "severity": severity,
                            "user_reported": "{{ user.username }}"
                        };

                        // Build AJAX request
                        $.ajax(URL, {
                            type: 'POST',
                            data: reportIncident,
                            headers: {
                                'X-CSRFToken': csrftoken
                            },
                            mode: 'same-origin',
                            success: function(data){
                                if(data.status === 1){
                                    location.href = '/home';
                                } else {
                                    location.href = '/report';
                                }
                            }
                        });

                    }

                });
            });

            // Send data to server via POST after submission
            //function sendData()

            // Set for Inputs with Captured Location
            function setFormLocation(lat,lng){
                // Element Variables
                let elLat = $('#latitude');
                let elLng = $('#longitude');
                // Set Values
                elLat.val(lat.toFixed(3));
                elLng.val(lng.toFixed(3));
                // Disable Fields
                elLat.prop({'disabled': true, 'readonly': true});
                elLng.prop({'disabled': true, 'readonly': true});
            }

            let latlng; // used to update coordinates as they change
            let markers = []; // will store markers

            // init map
            let map = L.map('report_map', {
                zoom: 13,
                dragging: !L.Browser.mobile,
                tap: !L.Browser.mobile,
                canvas: L.canvas()
            })
            .locate({setView: true, setZoom: 300})
            .on('locationfound', (e)=> {
                let marker = L.marker([e.latitude, e.longitude], {
                    maxZoom: 18,
                    tileSize: 512,
                    zoomOffset: -1,
                    draggable: true,
                    autoPan: true
                })
                // after the marker has been dropped, regather coordinates pass them out to global var
                .on('dragend', () => {
                    marker.unbindPopup();
                    latlng = marker.getLatLng();
                    e.latitude = latlng.lat;
                    e.longitude = latlng.lng;
                    marker.bindPopup('Lat: ' + latlng.lat.toFixed(6) + ', Lon: ' + latlng.lng.toFixed(6));
                    marker.openPopup();
                    circle.remove();
                    // Call on Every Marker Drag
                    setFormLocation(e.latitude, e.longitude);
                })
                // Binds new popup when dragend
                .bindPopup('Lat: ' + e.latitude + ', Lon: ' + e.longitude)

                // Create circle on init around user location
                let circle = L.circle([e.latitude, e.longitude], e.accuracy / 2, {
                    weight: 1,
                    color: '#b6e0e2',
                    fillColor: '#CACACA',
                    fillOpacity: 0.2
                })

                // Add the marker/circle to the map
                map.addLayer(marker);
                map.addLayer(circle);
                // Open the popup
                marker.openPopup();

                // Set Location and Form Elements
                setFormLocation(e.latitude, e.longitude);

                //initCompass(53, 3.6, 276.4);

            })
            // Usually permission is revoked if this is caused...
            .on('locationerror', (e) => {
                console.log('Location permission revoked: ' + (e));
            })

            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZGVhbjE5OTYiLCJhIjoiY2tsbDV6bGNxM2o4MDJuczhmdDR1dXhsYiJ9.gCVu5rbiMqcO1LKdVbWidg', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox/streets-v11',
                tileSize: 512,
                zoomOffset: -1,
                accessToken: 'pk.eyJ1IjoiZGVhbjE5OTYiLCJhIjoiY2tsbDV6bGNxM2o4MDJuczhmdDR1dXhsYiJ9.gCVu5rbiMqcO1LKdVbWidg'
            }).addTo(map);
        </script>

    {% endblock %}
</body>